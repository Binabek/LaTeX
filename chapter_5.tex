\chapter{Simulation Studies} \label{chap:sims}

\section{Simulation Codes} \label{sec:simCodes}

There is a veritable zoo of commonly used codes for simulating the dynamics of charged particel accelerators, all with different focuses, operating assumptions, supported hardware, and dynamics models. A few different simulation softwares were used for supplementary simulation studies of IOTA and the NIO system. There were two main codes used, and three supplemental codes. The main lattice code for design and control of the linear optics was Six D Simulation (SixDSim), a java based application written and maintained by Alexsandr (Sasha) Romanov, the resident IOTA lattice expert. SixDSim performs lattice funciton calculations for periodic and channel mode accelerator systems in the full six dimensions, so first order dispersive and path lengthning effects are automatically considered. SixDsim provides general lattice construction and optimizing functionality with a graphical environment (a rarity in accelerator codes). In addition to offline lattice desing and manipulation, SixDsim has support for control system integration and was the main driving engine for the linear optimization of linear optics (LOCO) which defined the IOTA bare lattice for experiments. It also allowed for application of complicated custom knobs for fine tuning the lattice between time intensive LOCO iterations. As such, the SixDsim lattice model contained the best fit of the experimental IOTA lattice and was used for extraction of lattice funcitons used in calculations.

The other primary code used for IOTA simulations was Impact-X \cite{heubelNext}, a particle tracking code under active development with a particular focus on particle-in-cell space charge modelling and efficient operation on large scale computing environments. Impact-X was selected for two main reasons, the first is its implementation of the DN NIO lenses, and its advanced space charge models. The space charge simulation capibilites ended up being moot, as the proton program at IOTA was sufficeintly delayed to fall outside the scope of this thesis. The implementation of the DN lenses in Impact-X is based on the complex representation formulated in \cite{mitchellComplex}, which has some benifits in stability near the x-axis in configuration space. This is unlike other common tracking codes MAd-X and Xsuite which implement the original parameterization of the DN lens. Generally, Impact-X is a robust symplectic tracking code with modern Python scritping support and expanding physics cabibilities. The whole complement of tracking simulations presented were performed with Impact-X.

MAD-X is the closest the accelerator community has to a standard, and as such is the code in which the generic IOTA lattice is described. The cpymad wrapper for Mad-X was used as the benchmark for lattice functions in the tracking codes to evaluate proper lattice implementation, due to its straightforward implementation into python workflows. Xsuite is the new tracking code developed at CERN to replace and supplement the many legacy codes in use. For this work Xsuite was used for additional lattice benchmarking and as an educational tool. Finally, a self programmed python tracking code was used for initial evaluation of invariant conservation in various nonlinear insert configurations. This is a valuable educational experience, but not a reccomended long term approach. All of these simulation were re-performed with equivalent Impact-X lattices for better reproducibility and clarity.

\section{NIO Simulations} \label{sec:dnSims}
The first simulations we will consider will be of the DN NIO system to demonstrate the underlying dynamics. The simulations are constructed in the drift-kick style, with the kick for the DN insert defined by the instantaneous change in momentum in a ruth-like formulation in equation \ref{eq:dnKick} \cite{mitchellComplex}. 

\begin{equation} 
\label{eq:dnKick}
\Delta p_x - i \Delta p_y = \Delta s \frac{t c}{\beta^{3/2}} \left( \frac{z_c}{1-z_c^2} + \frac{\arcsin{(z_c)}}{(1-z_c^2)^{3/2}} \right)
\end{equation}

The simplest insert configuration is a nonlinear insert drift with a thin matrix element providing the equal focusing. For ease of comparison, we match the IOTA NIO configuration with a 1.8 m drift with a phase advance of 0.3. This uiniquely constrains the lattice functions in the drift and sets the values in the focusing matrix. We will also add an aperture of a circle with a radius of 0.95 times the lab frame location of the singularity. We are only interested in the dynamics between the singularities as this is the physically practical region. \cite{mitchellBiforcation} touches on the predicted dynamics outside of these constraints. We choose aperture of 0.95 of the limit to avoid numerical issues near the singularities. 

To best approximate the nominal smooth longitudinal scaling of the DN potential, we integrate the insert with a sequence of 1800 kicks, subdividing the insert into millimeter-scale steps. The particles are initialized and monitored at the center of the insert. In the bare lattice this corresponds to the $\beta^*$ location where the $\alpha$ lattice functions are zero. This makes interpretation easy as the maximum amplitude of the oscillation shares the zero momentum condition. As we ramp the t-insert, the symmetry of the insert means the first order effect of the nonlinear magnets keeps the alpha zero at the center. The first simulation considered uses an inital grid of points which uniformly fills the central aperture in the transverse configuration space. Impact-X is a strictly 6-D code, so it is impossible to completely exclude the longitudinal dynamics, but the $ct$ and $p_t$ coordinates are uniformly zero, so any effects are the result of numerical error. The drifts in the nonlinear insert are strictly linear, and do not include chromatic effects. Figure \ref{fig:idealDNdetune} shows the resulting amplitude dependent detuning for this full configuration space range for a t-parameter of $t=-0.238$. The color indicates the relative inital coordinates, i.e. red points indicate only $y$ initial coordinates and blue the same for $x$. The tune was measured for each macroparticle with the NAFF algorighm and a first order Hann window. We see a very large tune footprint with a charactersitic "butterfly wing" profile. The largest detuning axis is dependent on the horizontal amplitude. There are some spurious features related to large horizontal excitations. We see a thin line of tunes crossing the main footprint from the lower "point", and a number of tunes on the $2Q_x + Q_y = 6$ line. The interpretation of this effect becomes more obvious in the tune versus amplitude space.

\begin{figure}
	\centering
	\includegraphics[width=0.8\linewidth]{./chapter_5_figures/impactxIdealDNdetunet238.pdf}
	\caption{Amplitude dependent detuning in tune space for idealized NIO system at $t=-0.238$. Color indicates relative initial transverse coordinates.}
	\label{fig:idealDNdetune}
\end{figure}

Figure \ref{fig:idealDNampDetune} displays the tunes versus the initial amplitude. The amplitude is calculated as the initial emittance for the bare lattice, to easily compare between different simulations. All points are present in each plot, so the perpendicular ampligudes are also present for a given labeled amplitude axis. The color scaling for relative ratio of kick amplitude has been retained. In addition to the general tune dependence on different amplitudes, we have a clear indicator on these extra features. Both features are present at excitations leading to detuning near the vertical integer resonance. Noteably, since the system is fully integrable, all of these orbits remain stable. The interpretation of the tune becomes difficult in this region, as the TBT frequency approaches zero. The system is strongly nonlinear, so the assumption of a dominant frequency breaks down. The measured tunes for amplitudes predicted to detune beyond the also pose a practical challenge, standard signal proccessing methods are sensitive only to the fractional component of the tune, so we are insensitive to whether the tune "rebounds" or passes down by an integer. 

\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{./chapter_5_figures/impactxIdealDNtuneVampt238.pdf}
	\caption{Tune versus initial amplitude for idealized NIO system at $t=-0.238$. Color indicates relative initial transverse coordinates.}
	\label{fig:idealDNampDetune}
\end{figure}

The characteristic Poincar\`e sections of the DN NIO system are shown in Figure \ref{fig:idealDNpoincare} in fully normalized coordinates. The system exhibits these "Spirograph" like patterns near the circle which would be traced by the basic courant snyder system in the phase space. The most notable effect in the configuration space is the nonlinear couplig which results in this "Hourglass" shape that the particle traces. This has some impacts on admittance considered in section \ref{sec:DA}.

\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{./chapter_5_figures/impactxThinDNexamplePhase_t238.pdf}
	\caption{Poincare sections for a single macroparticle of the horizontal and vertical phase spaces, and the configuration space for the idealized NIO system at $t=-0.238$}
	\label{fig:idealDNpoincare}
\end{figure}

We now need to consider more realistic nonlinear insert configurations. It is impractical to manufacture a magnet that smootly tapers with the required longitudinal scaling. To simulate the realistic IOTA insert, we need kicks which correspond to our 18 elements. This wil not perfectly match the neccesary integration of the potential, so we evaluate the quality of invariant conservation for this reduced number of elements. The following simulation consists of the IOTA style nonlinear insert with 18 equally spaced nonlinear thin kicks. We apply an aperture at the center of the insert consistent with the minimizing aperture in IOTA. Figure \ref{fig:v1idealInvariant} shows the resulting invariant conservation for the whole simulated grid of macroparticles. Here we have calculated the standard deviation of the invariants turn-by-turn. We see that the overall conservation quality has gone down, but our RMS is still below a tenth of a percent. In general, the quality of invariant conservation and approximation of the DN system improves for a larger numbers integration steps or slices.

\begin{figure}
	\centering
	\includegraphics[width=0.1\linewidth]{./placeholder.pdf}
	\caption{Invariant quantities conservation for the full IOTA aperture with real configuration of 18 kicks at $t=-0.238$}
	\label{fig:v1idealInvariant}
\end{figure}

This is the nominal t-parameter we may operate at, but we from a simulation point of view, we are also interested in the conservation of more nonlinear-dominated regions. Figure \ref{fig:v1idealt45} shows the conservation for a t-parameter of $t=-0.45$, which is almost at the vertical integer resonance.

\begin{figure}
	\centering
	\includegraphics[width=0.1\linewidth]{./placeholder.pdf}
	\caption{Invariant quantities conservation for the full IOTA aperture with real configuration of 18 kicks at $t=-0.45$}
	\label{fig:v1idealt45}
\end{figure}

The equal spacing configuration is the simplest apporoach to the system, but alternative configurations have been found have superior quality of integration. \cite{baturinHamiltonianPreservingNonlinear2022} proposes two alternative integration schemes, an equi-phase insert configuration, and an Yoshida-style \cite{yoshidaConstructionHigherOrder1990} higher order integrator. The equi-phase style integration can be straghtforwardly implemented as a new insert. Instead of placing elements equally spaced in lab frame positon, the elements are equally spaced in bare lattice phase advance. Figure \ref{fig:v2Idealt45} shows the quality of invariant conservation for and equi-phase insert with thin kicks. In this case we are at a t-parameter of $t=-0.45$, and are using 9 elements instead of 18. We can see that even for a reduced number of integration steps we have similar invariant conservation to the equal spacing in figure \ref{fig:v1idealt45}. This is a significant advantage in practically construcing these inserts, as we can arrive at the same NIO system quality with fewer expensive magnets. This configuration is the basis for the second IOTA insert covered in appendix \ref{apx:dnv2}.

\begin{figure}
	\centering
	\includegraphics[width=0.1\linewidth]{./placeholder.pdf}
	\caption{Invariant quantities conservation for the full IOTA aperture with equi-phase insert consistning of 9 kicks for $t=-0.45$}
	\label{fig:v2idealt45}
\end{figure}

\section{IOTA Tracking Simulations}
For better fidelity simulations for experimental design and comparison, we need to include the full IOTA lattice. The physical dimensions Impactx IOTA lattice used is based on the publically released version of the Mad-X lattice. The linear dynamics were benchmarked to this lattice configuration with simple gaussian beam simulations as Impact-X does not have direct first order lattice calculation capibilites. Lattice funcitons must be calculated from circulating beam with the proper assumptions. The lattice was configured to accept quadrupole settings from SixDSim lattices. In all Impact-X simulations, the idealized form of IOTA was used, matching the lattice in figure \ref{fig:inj6a}. This is without BPM offsets, dipole gradients, and the undulator corrections for easiest interpretability. identical simulations to those carried out with the transfer matrix yeilded similiar invariant conservation levels as seen in Figure \ref{fig:v1idealIvariant}. We can look at the detuning range given by the realistic aperture in Figure \ref{fig:IOTAminapFullDetune} for $t=-0.238$. The overall detuning shape is the same, but the range is much smaller, especially stemming from the reduction in horizontal aperture. The interpretation problem of the tunes near the integer resonance disappears in this realistic configuration, which simplifies the experimental analysis.

Impact-X supports a number of higher order effects which we can optionally include in the simulations to verify their impacts on invariant conservation and stability. The base condition considered above uses the linearized versions of the linear elements, i.e. drifts, quads, and dipoles. With respect to longitudinal effects, this means that we are considering disperion but not chromaticity. To begin to consider chromaticity, we change the quadrupole model to one which adds chromatic impacts, and the drifts to the exact model which includes the full geometric nonlinear term in momentum. The combination of this drift model and thin kicks is a sufficient Hamiltonian splitting for a drift-kick model of arbitrary kicks, so including nonlinear models in this lattice properly inlcudes their chromatic effects as well. Inthis configuration we can evaluate the chromaticity of the lattice, by directly measuring the tune dependence on energy. We see a discrepancy in the natural chromaticity of the Impact-X lattice compared with SixDSim. Additionally, the impacts of the sextupole families based on the nominal calibrations fail to accurrately, this likely stems from improper calibraiton of the sextupole current to strenght. Regardless, based on the measured impacts of the sextupoles in Impact-X, we can fully compensate the natural chromaticity in the lattice. Finally, in additoin to chromatic effects, we can introduce models of the expected residual nonlinearities in the bare lattice. The two elements considered in Impact-X are quadrupole fringe fields and geometric nonlinearites from the short bending radii of the dipoles.
